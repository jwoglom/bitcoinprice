<!doctype html>
<html>
<head>
<!--
StationStatus
=============
A web-based and mobile-optimized application for viewing the status of the Washington DC Metro system.

James Woglom
www.wogloms.com / j@wogloms.net
-->
    <title>Bitcoin status</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=1">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,600,300' rel='stylesheet' type='text/css'>
    
    <link rel="stylesheet" type="text/css" href="ui.core.css" />
    <link rel="stylesheet" type="text/css" href="ui.card.css" />

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript">


    </script>
</head>
<body>
<style type="text/css">
.header .logo {
    background-image: url(logo-orange.png);
    background-size: 32px 32px;
    background-repeat: no-repeat;
    background-position: center center;
    line-height: 0px;
    text-indent: -999px;
}
.card.price-top {
    height: 96px;
    position: relative;
}
.card.price-top .top-input {
    font-size: 80px;
    margin: 0;
    border: 0;
    background: 0;
    text-align: center;
    width: 100%;
    width: calc(100% - 2px);
}
.card.price-top .currency-label {
    position: absolute;
    top: 78px;
    right: 2px;
    font-size: 16px;
    line-height: 16px;
}
.card.price-bot {
    height: 32px;
    margin-top: -14px;
    position: relative;
}
.card.price-bot .bot-input {
    font-size: 26px;
    margin: 0;
    border: 0;
    background: 0;
    text-align: center;
    width: 100%;
    width: calc(100% - 2px);
}

.card.price-bot .currency-label {
    position: absolute;
    top: 14px;
    right: 2px;
    font-size: 16px;
    line-height: 16px;
}
.card.price.usd > .currency-label {
    right: -1px;
}
.card.price.usd > .currency-label:before {
    content: "USD";
}
.card.price.btc > .currency-label:before {
    content: "BTC";
}

.card.pvs {
    height: 33px;
}

</style>
<script type="text/javascript">
$(document).ready(function() {
    btc = {
        data: {},
        prices: {},
        pvs: {
            'bitstamp': 'Bitstamp',
            'bitfinex': 'Bitfinex',
            'btce': 'BTC-e',
            'itbit': 'itBit',
            'coinbase': 'Coinbase'
        },
        curPv: 'bitstamp',
        init: function() {
            this.fetchamount();
        },
        callback: function() {
            this.fill();
            this.add();
            this.triggers();
            $(".card.price.btc > input").val("1.00");
            this.showBTC(1.00);
        },
        fill: function() {
            $p = $(".card.pvs");
            for(var i in this.pvs) {
                this.prices[i] = this.getconv(i);
                $p.append("<div class='bottom-button pv "+i+"'>"+this.pvs[i]+"</div>");
                $p.css("height", parseInt($p.css("height")) + 40);
            }
            console.log(this.prices);
        },
        add: function() {
            $(".card.price-top").addClass("usd").attr("data-currency", "usd");
            $(".card.price-bot").addClass("btc").attr("data-currency", "btc");
        },
        triggers: function() {
            $(".card.price.btc > input").keyup(function() {
                btc.showBTC($(this).val());
            });
            $(".card.price.usd > input").keyup(function() {
                btc.showUSD($(this).val());
            });
            $(".card.price-top > input").keyup(this.sizeTop);
            $(".card.price-bot > input").keyup(this.sizeBot);
        },
        sizeTop: function() { // bound to input
            var sw = $(document).width();
            var snapStart = 68; // width needed for 1 place
            var snapInt = 51; // width needed for each additional place
            var p = parseInt((sw - snapStart) / snapInt); // number of places to show
            var l = (""+parseFloat($(this).val())).length; // number of places
            var s = 80 * p/l;
            if(s > 80) s = 80;
            console.debug(p, l, s);
            $(this).css("font-size", s+"px");
        },
        sizeBot: function() { // bound to input

        },
        placeval: function(val, pv) {
            return (parseInt(val * Math.pow(10,pv)) / Math.pow(10,pv)).toLocaleString();
        },
        showBTC: function(btcs) {
            var amo = parseFloat(btcs);
            var conv = this.prices[this.curPv];
            var r = amo * conv;
            if(r == NaN || !(r<0 || r>=0)) return;
            console.info(btcs+"BTC = "+r+"USD");
            $(".card.price.usd > input").val(this.placeval(r, 2));
        },
        showUSD: function(usds) {
            var amo = parseFloat(usds);
            var conv = this.prices[this.curPv];
            var r = amo * (1 / conv);
            if(r == NaN || !(r<0 || r>=0)) return;
            console.info(usds+"USD = "+r+"BTC");
            $(".card.price.btc > input").val(this.placeval(r, 6));
        },
        fetchamount: function() {
            var _st = +new Date;
            $.get("blob.php", {}, function(d) {
                btc.data = JSON.parse(d);
                btc.prices = btc.data.prices;
                console.log(btc.data);
                btc.callback.bind(btc)();
                console.log("Done "+(+new Date - _st));
            }, "text");
        },
        getconv: function(pv) {
            return parseFloat(this.data.prices[pv].last);
        }
    };

    btc.init();
});
</script>
<div class="container">
    <div class="header">
        <div class="logo">
            B
        </div>
        <div class="title">Bitcoin</div>
    </div>

    <div class="contents">
        <div class="card price price-top">
            <input class="top-input" value="000.00" />
            <div class="currency-label"></div>
        </div>
        <div class="card price price-bot">
            <input class="bot-input" value="0.00" />
            <div class="currency-label"></div>
        </div>

        <div class="card pvs">
            <div class="title">Provider:</div>
        </div>
    </div>
</div>
</body>
</html>